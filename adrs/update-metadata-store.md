# Update metadata store

## Status

Proposed

## Context

When exploring the data in the dashboard, users first a data layer, and the API returns all of the avaiable dates for that data layer, and automatically loads the most recent date in the dashboard. Functionality to list the available dates for a given layer (dataset domain) has gone through several iterations: 
1. Hard coded in JSON in the front end 
2. Generated by the API by scanning the contents of the S3 bucket with each request to the `/datasets` endpoint
3. Generated once every 24 hrs by a lambda function then stored as a JSON file in S3 which is then queried by the API with each request to the `/datasets` endpoint.

Dataset metadata files that define the paramters that the dashboard should use to display the dataset are implemented as static JSON files returned by the API.

There are several important chanllenges we are faced with using this approach: 
- As we move towards a "spotlight-free" dashboard implementation, we've agreed that the API needs to return a geometric representation (lat/lon, bounding box, etc) of the underlying data, until the appropriate zoom level is reach, at which point the dashboard will switch to requesting the data tiles themselves. This implies that going forward, for a given data layer, the API will have to return available dates and geometries for each each date. Implement a process for extracting the geometry of uploaded data files and serializing them to S3 further complicates the already complex process of dataset domain generation.
- The zoom level at which the dashboard switches from displaying geometry representation of the data to displaying the data itself may be stored at the item level or at the dataset level.
- Some scientists have requested more granular control of certain metadata values (eg: CO2 rescale values need to be different for each year, CMIP6 colour map should be different for dates 1950-2014 and 2015-2100 to indicate training/historical data vs model predictions). This is yet another complexity to add to the dataset domain JSON file. 
- The API returns a preformatted URL to the frontend, where the frontend replaces the `spotlightId` and `date` values in order to make the correct request to the tiling endpoint. As we move away from spotlights and implement more complex "toggling" functionality (eg: toggling betwene the various CMIP6 models and scenarios) we will need to implement more complex S3 URI templating. 

The "workarounds" necessary to implement/resolve the above challenges essentially amount to re-creating a STAC catalog without a searchable interface, which brings us to the decision:

## Decision

Implement a STAC API to catalog the data holdings of the Dashboard Evolution. 

## Consequences

- Provides data searchable by temporal and geographic extent
- Allows us to implement both item and collection level metadata (eg: yearly rescale values)
- Allows us to establish data provenance using the `derived_from` property
- Enables item level comparison features, background tiles, mosaic files, etc using the `assets` property
- Furthers the dashboard + API as an "out-of-the-box" solution, since many users already use STAC to catalog their data holding
- Introduces complexity for the front-end, as the dashboard will now how to query again the STAC API's search endpoint in order to display available data to the user. This can be mitigated in the meanwhile by keeping the STAC API behind the dashboard API, and "massaging" the results to fit the current endpoint format as it passes through. 